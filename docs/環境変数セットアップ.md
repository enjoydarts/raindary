# 環境変数セットアップガイド

## 概要

このドキュメントでは、Raindrop AIの開発・本番環境で必要な環境変数の取得方法を説明します。

---

## ✅ 完了済み

以下の環境変数は既に`.env.local`に設定済みです：

- `AUTH_SECRET`: ランダム生成済み
- `ENCRYPTION_KEY`: ランダム生成済み
- `DATABASE_URL`: ローカルPostgreSQL接続情報
- `INNGEST_*`: ローカル開発用の設定
- `EXTRACT_API_URL`: ローカル抽出サービスURL

---

## 🔑 取得が必要な環境変数

### 1. Raindrop.io OAuth認証情報

**必須度**: 🔴 必須（ローカル開発・本番共通）

#### 取得手順

1. **Raindrop.ioにログイン**
   - https://raindrop.io にアクセス

2. **App Management Consoleを開く**
   - https://raindrop.io/app/settings/integrations にアクセス
   - または: Settings → Integrations → For Developers

3. **新しいアプリを作成**
   - 「Create new app」ボタンをクリック
   - **App name**: `Raindrop AI` (任意)
   - **Redirect URI**: `http://localhost:3000/api/auth/callback/raindrop`
     - 本番環境用には別途 `https://your-domain.com/api/auth/callback/raindrop` も追加

4. **認証情報を取得**
   - 作成後、`Client ID`と`Client Secret`が表示される
   - これらを`.env.local`に追加:
     ```bash
     AUTH_RAINDROP_ID=your_client_id
     AUTH_RAINDROP_SECRET=your_client_secret
     ```

#### 注意事項

- Client Secretは**絶対に外部に公開しない**
- Redirect URIは正確に設定する（末尾のスラッシュも重要）
- テスト用と本番用で別々のアプリを作成することを推奨

---

### 2. Anthropic Claude APIキー

**必須度**: 🔴 必須（要約生成機能を使う場合）

#### 取得手順

1. **Anthropic Consoleにアクセス**
   - https://console.anthropic.com/ にアクセス

2. **アカウント作成/ログイン**
   - Googleアカウントまたはメールアドレスで登録

3. **APIキーを作成**
   - 左メニューから「API Keys」を選択
   - 「Create Key」ボタンをクリック
   - キー名を入力（例: `Raindrop AI - Development`）
   - 生成されたキーをコピー

4. **環境変数に設定**
   ```bash
   ANTHROPIC_API_KEY=sk-ant-xxxxxxxxxxxxx
   ```

#### 注意事項

- APIキーは**1回しか表示されない**ので、必ずコピーして保存
- 使用量に応じて課金される（料金: https://www.anthropic.com/pricing）
- テスト用と本番用で別々のキーを使用することを推奨
- 環境変数に設定後、Gitにコミットしないよう注意（`.env.local`は`.gitignore`済み）

#### コスト目安

- 事実抽出（Haiku）: 約$0.0008/記事
- 要約生成（Sonnet）: 約$0.003/記事
- **合計**: 約$0.004/記事（1000記事で約$4）

---

## 🔵 オプション（本番環境用）

### 3. Supabase認証情報

**必須度**: 🟡 オプション（本番環境でSupabaseを使う場合）

ローカル開発では、Docker ComposeのPostgreSQLを使用するため不要です。

#### 取得手順

1. **Supabaseにアクセス**
   - https://supabase.com にアクセス

2. **プロジェクトを作成**
   - 「New Project」をクリック
   - プロジェクト名、データベースパスワードを設定
   - リージョンを選択（日本の場合: `Northeast Asia (Tokyo)`）

3. **認証情報を取得**
   - Project Settings → API
   - 以下の値をコピー:
     - `Project URL`
     - `anon public` key
     - `service_role` key（Secretを表示）

4. **環境変数に設定**
   ```bash
   SUPABASE_URL=https://xxxxx.supabase.co
   SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
   SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
   ```

#### 注意事項

- `service_role` keyは**管理者権限**を持つため、絶対に外部に公開しない
- 無料プランでも十分な機能が使える
- RLS（Row Level Security）ポリシーを必ず設定すること

---

### 4. Upstash Redis（レート制限用）

**必須度**: 🟢 オプション（本番環境でレート制限を使う場合）

ローカル開発では不要です。

#### 取得手順

1. **Upstashにアクセス**
   - https://upstash.com にアクセス

2. **Redisデータベースを作成**
   - 「Create Database」をクリック
   - データベース名を入力（例: `raindary-ratelimit`）
   - リージョンを選択
   - Typeは`Regional`を選択（無料プラン可）

3. **認証情報を取得**
   - データベース詳細画面で「REST API」タブを選択
   - `UPSTASH_REDIS_REST_URL`と`UPSTASH_REDIS_REST_TOKEN`をコピー

4. **環境変数に設定**
   ```bash
   UPSTASH_REDIS_REST_URL=https://xxxxx.upstash.io
   UPSTASH_REDIS_REST_TOKEN=xxxxxxxxxxxxx
   ```

#### 注意事項

- 無料プランは10,000コマンド/日まで
- Vercelと統合されているため、Vercel環境変数として設定すると自動的に使える

---

### 5. Inngest Cloud（本番環境用）

**必須度**: 🟡 オプション（本番環境でInngestを使う場合）

ローカル開発では、Docker ComposeのInngest Dev Serverを使用するため不要です。

#### 取得手順

1. **Inngestにアクセス**
   - https://www.inngest.com にアクセス

2. **アカウント作成**
   - GitHubアカウントでサインアップ

3. **アプリを作成**
   - 「Create App」をクリック
   - アプリ名を入力（例: `raindary`）

4. **認証情報を取得**
   - App Settings → Keys
   - `Event Key`と`Signing Key`をコピー

5. **環境変数に設定**
   ```bash
   INNGEST_EVENT_KEY=xxxxxxxxxxxxx
   INNGEST_SIGNING_KEY=signkey-prod-xxxxxxxxxxxxx
   INNGEST_DEV=0
   # INNGEST_BASE_URLは不要（自動的にクラウドに接続）
   ```

#### 注意事項

- 無料プランあり（月間1,000関数実行まで）
- `INNGEST_DEV=0`にすることで本番モードになる

---

## 📋 環境変数チェックリスト

### ローカル開発環境

- [x] `AUTH_SECRET` - 生成済み
- [x] `ENCRYPTION_KEY` - 生成済み
- [x] `DATABASE_URL` - ローカルPostgreSQL設定済み
- [x] `INNGEST_*` - ローカル設定済み
- [x] `EXTRACT_API_URL` - ローカル設定済み
- [ ] `AUTH_RAINDROP_ID` - 要取得
- [ ] `AUTH_RAINDROP_SECRET` - 要取得
- [ ] `ANTHROPIC_API_KEY` - 要取得（要約機能を使う場合）

### 本番環境

- [ ] `AUTH_SECRET` - 新規生成（ローカルとは別の値）
- [ ] `ENCRYPTION_KEY` - 新規生成（ローカルとは別の値）
- [ ] `AUTH_RAINDROP_ID` - 本番用Redirect URI設定
- [ ] `AUTH_RAINDROP_SECRET` - 本番用アプリ
- [ ] `ANTHROPIC_API_KEY` - 本番用キー推奨
- [ ] `SUPABASE_URL` - Supabaseプロジェクト
- [ ] `SUPABASE_ANON_KEY` - Supabaseプロジェクト
- [ ] `SUPABASE_SERVICE_ROLE_KEY` - Supabaseプロジェクト
- [ ] `INNGEST_EVENT_KEY` - Inngest Cloud
- [ ] `INNGEST_SIGNING_KEY` - Inngest Cloud
- [ ] `UPSTASH_REDIS_REST_URL` - オプション
- [ ] `UPSTASH_REDIS_REST_TOKEN` - オプション

---

## 🔒 セキュリティのベストプラクティス

1. **環境変数ファイルを絶対にGitにコミットしない**
   - `.env.local`は`.gitignore`に含まれていることを確認

2. **本番環境とローカル環境で異なる値を使用**
   - 特に`AUTH_SECRET`と`ENCRYPTION_KEY`は必ず別の値にする

3. **定期的にキーをローテーション**
   - APIキーは3〜6ヶ月ごとに再生成を推奨

4. **最小権限の原則**
   - 必要な権限のみを持つキーを使用

5. **Vercel環境変数の暗号化**
   - Vercelの環境変数は自動的に暗号化されるため、安全に保管できる

---

## 🚀 次のステップ

環境変数の設定が完了したら、以下を実施：

1. **Docker Composeで起動**

   ```bash
   docker compose up --build
   ```

2. **動作確認**
   - Next.js: http://localhost:3000
   - Extract API: http://localhost:8000
   - Inngest: http://localhost:8288

3. **Raindrop OAuth認証テスト**
   - ログイン画面でRaindrop認証を試す

4. **要約生成テスト**
   - 記事を取り込んで要約生成を実行
